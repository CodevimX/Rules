name: Sync from Upstream

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´12:00è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´20:00ï¼‰
    - cron: '0 12 * * *'
  workflow_dispatch:
    # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Add upstream remote
      run: |
        git remote add upstream https://github.com/${{ vars.UPSTREAM_REPO }}.git
        git fetch upstream

    - name: Check for changes
      id: check
      run: |
        git log --oneline upstream/main..main
        if [ $(git rev-list upstream/main..main --count) -eq 0 ]; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æ²¡æœ‰å‘ç°æ–°æ›´æ–°"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ”µ å‘ç°æ–°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
        fi

    - name: Create Sync Branch
      if: steps.check.outputs.changes == 'true'
      run: |
        git checkout -b sync-upstream-$(date +%Y%m%d)
        git merge upstream/main --no-edit
        # åŸºç¡€å®‰å…¨æ‰«æ
        echo "ğŸ” æ­£åœ¨è¿›è¡ŒåŸºç¡€å®‰å…¨æ‰«æ..."
        find . -name "*.js" -exec echo "æ£€æŸ¥æ–‡ä»¶: {}" \;
        echo "âœ… åŸºç¡€æ‰«æå®Œæˆï¼Œè¯·äººå·¥å®¡æŸ¥å…·ä½“ä»£ç å˜æ›´"

    - name: Create Pull Request
      if: steps.check.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ–° - $(date +'%Y-%m-%d')"
        title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–° - $(date +'%Y-%m-%d')"
        body: |
          æœ¬æ¬¡è‡ªåŠ¨åŒæ­¥æ¥è‡ªä¸Šæ¸¸ä»“åº“çš„æ›´æ–°ï¼Œè¯·ä»”ç»†å®¡æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

          ## ğŸ” å®‰å…¨æ£€æŸ¥æ¸…å•
          - [ ] æ£€æŸ¥æ–°å¢çš„ç½‘ç»œè¯·æ±‚åŸŸå
          - [ ] å®¡æŸ¥æ˜¯å¦æœ‰å¯ç–‘çš„eval()æˆ–Function()è°ƒç”¨
          - [ ] ç¡®è®¤è„šæœ¬åŠŸèƒ½ä¸æè¿°ä¸€è‡´
          - [ ] æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦å¼‚å¸¸å˜åŒ–

          ## ğŸ“ å˜æ›´å†…å®¹
          è¯·æŸ¥çœ‹ä¸‹é¢çš„æ–‡ä»¶å·®å¼‚ï¼Œç¡®è®¤å®‰å…¨ååˆå¹¶æ­¤PRã€‚

          > **é‡è¦**ï¼šåˆå¹¶åLoonå°†è‡ªåŠ¨ä½¿ç”¨æ›´æ–°åçš„è„šæœ¬
        branch: "sync-upstream-$(date +%Y%m%d)"
        base: main
        labels: "auto-sync,security-review"
