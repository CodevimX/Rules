name: Sync from Upstream

on:
  schedule:
    - cron: '0 12 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"

    - name: Add upstream remote
      run: |
        # è¯·ç¡®ä¿è¿™é‡Œçš„ä»“åº“åœ°å€æ˜¯æ­£ç¡®çš„ï¼
        git remote add upstream https://github.com/BOBOLAOSHIV587/Rules.git
        git fetch upstream

    - name: Check for changes
      id: check
      run: |
        # æ£€æŸ¥æ˜¯å¦æœ‰å·®å¼‚
        if git diff --quiet main upstream/main; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "ğŸŸ¢ æ²¡æœ‰å‘ç°æ–°æ›´æ–°"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ”µ å‘ç°æ–°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
          echo "å˜æ›´çš„æ–‡ä»¶ï¼š"
          git diff --name-only main upstream/main
        fi

    - name: Create Pull Request with Unique Branch
      if: steps.check.outputs.changes == 'true'
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ”„ è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸æ›´æ–° - $(date +'%Y-%m-%d')"
        title: "ğŸ”„ è‡ªåŠ¨åŒæ­¥æ›´æ–° - $(date +'%Y-%m-%d')"
        body: |
          æœ¬æ¬¡è‡ªåŠ¨åŒæ­¥æ¥è‡ªä¸Šæ¸¸ä»“åº“çš„æ›´æ–°ï¼Œè¯·ä»”ç»†å®¡æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

          ## ğŸ” å®‰å…¨æ£€æŸ¥æ¸…å•
          - [ ] æ£€æŸ¥æ–°å¢çš„ç½‘ç»œè¯·æ±‚åŸŸå
          - [ ] å®¡æŸ¥æ˜¯å¦æœ‰å¯ç–‘çš„eval()æˆ–Function()è°ƒç”¨
          - [ ] ç¡®è®¤è„šæœ¬åŠŸèƒ½ä¸æè¿°ä¸€è‡´
          - [ ] æ£€æŸ¥æ–‡ä»¶å¤§å°æ˜¯å¦å¼‚å¸¸å˜åŒ–

          ## ğŸ“ å˜æ›´å†…å®¹
          è¯·æŸ¥çœ‹ä¸‹é¢çš„æ–‡ä»¶å·®å¼‚ï¼Œç¡®è®¤å®‰å…¨ååˆå¹¶æ­¤PRã€‚

          > **é‡è¦**ï¼šåˆå¹¶åLoonå°†è‡ªåŠ¨ä½¿ç”¨æ›´æ–°åçš„è„šæœ¬
        branch: "sync-upstream-$(date +%Y%m%d-%H%M%S)"
        base: main
        labels: "auto-sync,security-review"
